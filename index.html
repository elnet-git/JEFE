<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventarios JQ Motors - Unificado</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
    --azul:#0044cc;
    --azul-osc:#003399;
    --bg:#f4f6fa;
    --card:#ffffff;
    --gris:#666;
    --gris-claro:#eee;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin:0; padding:0; background:var(--bg); color:#111;
}
h2 {
    margin:20px 0; color:var(--azul);
    text-align:center; font-weight:700;
}
.container {
    max-width:1200px; margin:0 auto; padding:20px;
}
.controls {
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center; margin-bottom:10px;
}
.controls .wide { flex:1 1 300px; max-width:600px; }
.controls input, .controls select, .controls button {
    padding:10px; font-size:16px; border-radius:6px;
    border:1px solid var(--gris-claro); box-sizing:border-box;
}
.controls input:focus, .controls select:focus { outline:none; border-color:var(--azul); }
.controls button {
    cursor:pointer; background:var(--azul); color:white;
    border:none; font-weight:600; transition:0.3s;
}
.controls button:hover { background:var(--azul-osc); }

#mensaje {
    text-align:center;
    font-weight:600;
    color:#b00;
    margin-bottom:16px;
}

.scroll-box {
    width: 100%;
    max-height: 550px;
    overflow-y:auto;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.12);
    background:var(--card);
}

table {
    width:100%;
    border-collapse:collapse;
}
thead th {
    position:sticky; top:0;
    background:var(--azul); color:white;
    padding:12px; font-size:13px; text-transform:uppercase;
    text-align:center;
}
tbody td {
    padding:10px; font-size:14px; border-bottom:1px solid var(--gris-claro);
    text-align:center;
}
tbody tr:nth-child(even){ background:#fbfbfb; }
tbody tr:hover { background:#e8f0ff; }

@media(max-width:768px){
    .controls { flex-direction:column; }
}
</style>
</head>
<body>
<div class="container">
    <h2>Inventarios JQ Motors - Unificado</h2>

    <div id="mensaje">Cargando inventarios...</div>

    <div class="controls">
        <input id="busqueda" class="wide" type="text" placeholder="Buscar código o descripción..." onkeyup="filtrarTodo()">

        <select id="selectAgencia" style="max-width:250px;" onchange="filtrarAgencia()">
            <option value="">-- AGENCIAS --</option>
            <option value="matriz">Matriz</option>
            <option value="impulsora">Impulsora</option>
            <option value="tultitlan">Tultitlán</option>
            <option value="ojo_de_agua">Ojo de Agua</option>
            <option value="pachuca">Pachuca</option>
            <option value="mixquiahuala">Mixquiahuala</option>
        </select>

        <button onclick="exportarInventario()" style="max-width:180px;">Exportar CSV</button>
    </div>

    <div class="scroll-box">
        <table>
            <thead>
                <tr>
                    <th>Agencia</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Stock</th>
                </tr>
            </thead>
            <tbody id="resultados"></tbody>
        </table>
    </div>
</div>

<script>
/* ================= AGENCIAS Y URLS ================= */
const AGENCIAS = {
    "matriz": "https://inv-matriz-server.onrender.com/inventario-json",
    "impulsora": "https://inv-impulsora-server.onrender.com/inventario-json",
    "tultitlan": "https://inv-tultitlan-server.onrender.com/inventario-json",
    "ojo_de_agua": "https://inv-ojo-de-agua-server.onrender.com/inventario-json",
    "pachuca": "https://inv-pachuca-server.onrender.com/inventario-json",
    "mixquiahuala": "https://inv-mixquiahuala-server.onrender.com/inventario-json"
};

const URLS = Object.values(AGENCIAS);
const MAPA_URL_A_NOMBRE = Object.fromEntries(
    Object.entries(AGENCIAS).map(([k,v])=>[v,k])
);

const NOMBRES_AMIGABLES = {
    "matriz":"Matriz",
    "impulsora":"Impulsora",
    "tultitlan":"Tultitlán",
    "ojo_de_agua":"Ojo de Agua",
    "pachuca":"Pachuca",
    "mixquiahuala":"Mixquiahuala"
};

let inventario = [];

/* ================= CARGAR INVENTARIOS ================= */
async function cargarInventarios(){
    mostrarMensaje("Cargando inventarios...");

    const fetches = URLS.map(async url => {
        try{
            const r = await fetch(url);
            if(r.ok){
                const datos = await r.json();
                const nombre = MAPA_URL_A_NOMBRE[url];
                const procesados = datos.map(x => ({
                    ...x,
                    agencia: (x.agencia || nombre)
                        .toLowerCase()
                        .replace(/ /g, "_")
                        .replace(/-/g, "_")
                }));
                console.log(`Agencia ${nombre}: ${procesados.length} productos cargados`);
                return procesados;
            } else {
                console.warn("Error en:", url);
                return [];
            }
        }catch(e){
            console.warn("No respondió:", url);
            return [];
        }
    });

    const resultados = await Promise.all(fetches);

    resultados.forEach(datos => {
        datos.forEach(item => {
            const key = item.agencia + "|" + item.codigo;
            if(!inventario.some(x => (x.agencia + "|" + x.codigo) === key)){
                inventario.push(item);
            }
        });
    });

    filtrarTodo();
    mostrarMensaje("Inventarios cargados correctamente.");
}

/* ================= MOSTRAR TABLA ================= */
function mostrarResultados(datos){
    const tb = document.getElementById("resultados");
    tb.innerHTML = "";

    if(datos.length === 0){
        tb.innerHTML = "<tr><td colspan='4'>No hay datos</td></tr>";
        return;
    }

    datos.sort((a,b)=> a.agencia.localeCompare(b.agencia));

    datos.forEach(item=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${NOMBRES_AMIGABLES[item.agencia] || item.agencia}</td>
            <td>${item.codigo}</td>
            <td style="text-align:left">${item.descripcion}</td>
            <td>${item.stock}</td>
        `;
        tb.appendChild(tr);
    });
}

/* ================= FILTRADO ================= */
function filtrarTodo(){
    const txt = document.getElementById("busqueda").value.toLowerCase();
    let agencia = document.getElementById("selectAgencia").value;
    agencia = agencia.replace(/-/g, "_");

    const filtrado = inventario.filter(x =>
        (!agencia || x.agencia === agencia) &&
        ((x.codigo||"").toLowerCase().includes(txt) ||
         (x.descripcion||"").toLowerCase().includes(txt))
    );
    mostrarResultados(filtrado);
}

function filtrarAgencia(){
    filtrarTodo();
}

/* ================= EXPORTAR ================= */
function exportarInventario(){
    const txt = document.getElementById("busqueda").value.toLowerCase();
    let agencia = document.getElementById("selectAgencia").value;
    agencia = agencia.replace(/-/g, "_");

    const filtrado = inventario.filter(x =>
        (!agencia || x.agencia === agencia) &&
        ((x.codigo||"").toLowerCase().includes(txt) ||
         (x.descripcion||"").toLowerCase().includes(txt))
    );

    let csv = "Agencia,Código,Descripción,Stock\n";
    filtrado.forEach(x=>{
        csv += `"${NOMBRES_AMIGABLES[x.agencia] || x.agencia}","${x.codigo}","${x.descripcion}","${x.stock}"\n`;
    });

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "inventario_filtrado.csv";
    a.click();
}

/* ================= UTIL ================= */
function mostrarMensaje(t){
    document.getElementById("mensaje").textContent = t;
}

/* ================= INICIO ================= */
cargarInventarios();
</script>

</body>
</html>
