from flask import Flask, request, jsonify
import json
import os

from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(name)
CORS(app)  # esto habilita CORS para todos los orÃ­genes

Archivo donde el proxy guarda el inventario en uso

INVENTARIO_FILE = "inventarios_recibidos.json"

Ruta del JSON real de tu matriz

JSON_MATRIZ = r"C:\Users\infob\Desktop\inventarios\agencias\matriz\inventario_render.json"

----------------------------------------

FUNCIONES DE UTILIDAD

----------------------------------------

def cargar_inventario():
if not os.path.exists(INVENTARIO_FILE):
return []
try:
with open(INVENTARIO_FILE, "r", encoding="utf-8") as f:
return json.load(f)
except:
return []

def guardar_inventario(data):
with open(INVENTARIO_FILE, "w", encoding="utf-8") as f:
json.dump(data, f, ensure_ascii=False, indent=4)

----------------------------------------

RUTAS DEL PROXY

----------------------------------------

@app.route("/")
def home():
return "Servidor PROXI JQ Motors activo."

@app.route("/inventario", methods=["POST"])
def recibir_inventario():
data = request.get_json()
agencia = data.get("agencia")
inventario = data.get("inventario", [])

# Normalizar inventario: solo cÃ³digo, descripciÃ³n, stock y agencia  
inventario_final = []  
for item in inventario:  
    inventario_final.append({  
        "codigo": item.get("codigo", ""),  
        "descripcion": item.get("descripcion", ""),  
        "stock": item.get("stock", 0),  
        "agencia": agencia  
    })  

guardar_inventario(inventario_final)  
return jsonify({"status": "actualizado"})

@app.route("/inventario-json", methods=["GET"])
def obtener_inventario():
contenido = cargar_inventario()
return jsonify(contenido)

@app.route("/limpiar", methods=["POST"])
def limpiar_inventario():
guardar_inventario([])
return jsonify({"status": "inventario_limpiado"})

----------------------------------------

FUNCION PARA ACTUALIZAR DESDE MATRIZ

----------------------------------------

def actualizar_inventario_matriz():
if not os.path.exists(JSON_MATRIZ):
print("âŒ inventario_render.json de matriz no encontrado")
return
try:
with open(JSON_MATRIZ, "r", encoding="utf-8") as f:
inventario_real = json.load(f)
# Normalizar inventario real al guardar
inventario_final = []
for item in inventario_real:
inventario_final.append({
"codigo": item.get("codigo", ""),
"descripcion": item.get("descripcion", ""),
"stock": item.get("stock", 0),
"agencia": "matriz"  # asigna la agencia de la matriz
})
guardar_inventario(inventario_final)
print("âœ… Inventario de matriz actualizado en el proxy.")
except Exception as e:
print("âŒ Error actualizando inventario de matriz:", e)

@app.route("/actualizar-matriz", methods=["POST"])
def actualizar_desde_matriz():
actualizar_inventario_matriz()
return jsonify({"status": "actualizado"})

----------------------------------------

EJECUCIÃ“N LOCAL

----------------------------------------

if name == "main":
print("ðŸ”„ Proxy iniciado. Usando el Ãºltimo inventario guardado.")
app.run(host="0.0.0.0", port=5002)

