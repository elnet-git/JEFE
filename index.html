from flask import Flask, request, jsonify
from flask_cors import CORS
import json
import os

app = Flask(__name__)

# CORS totalmente abierto (para cualquier red, dispositivo, app m√≥vil, render, etc.)
CORS(app, resources={r"/*": {"origins": "*"}})

# ============================================
# CONFIGURACI√ìN
# ============================================
INVENTARIO_FILE = "inventarios_recibidos.json"
JSON_MATRIZ = r"C:\Users\infob\Desktop\inventarios\agencias\matriz\inventario_render.json"

# TOKEN SECRETO PARA PROTEGER EL PROXY
TOKEN = "JQM2025TOKEN"  # ‚Üê C√°mbialo cuando quieras


# ============================================
# FUNCIONES UTILIDAD
# ============================================
def cargar_inventario():
    if not os.path.exists(INVENTARIO_FILE):
        return []
    try:
        with open(INVENTARIO_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return []


def guardar_inventario(data):
    with open(INVENTARIO_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)


# ============================================
# MIDDLEWARE DE SEGURIDAD
# ============================================
@app.before_request
def validar_token():
    if request.path == "/":  
        return  # home no necesita token

    token_recibido = request.headers.get("Token")

    if token_recibido != TOKEN:
        return jsonify({"error": "Token inv√°lido o no enviado"}), 401


# ============================================
# RUTAS DEL PROXY
# ============================================
@app.route("/")
def home():
    return "Proxy JQ Motors en Producci√≥n | Activo y Seguro."


@app.route("/inventario", methods=["POST"])
def recibir_inventario():
    data = request.get_json()

    agencia = data.get("agencia")
    inventario = data.get("inventario", [])

    if not agencia:
        return jsonify({"error": "Debes enviar el nombre de la agencia"}), 400

    inventario_final = []
    for item in inventario:
        inventario_final.append({
            "codigo": item.get("codigo", "").upper(),
            "descripcion": item.get("descripcion", ""),
            "stock": int(item.get("stock", 0)),
            "agencia": agencia
        })

    guardar_inventario(inventario_final)
    return jsonify({"status": "inventario_actualizado", "agencia": agencia})


@app.route("/inventario-json", methods=["GET"])
def obtener_inventario():
    return jsonify(cargar_inventario())


@app.route("/limpiar", methods=["POST"])
def limpiar_inventario():
    guardar_inventario([])
    return jsonify({"status": "inventario_limpiado"})


# ============================================
# ACTUALIZAR DESDE MATRIZ
# ============================================
def actualizar_inventario_matriz():
    if not os.path.exists(JSON_MATRIZ):
        print("ERROR: No se encontr√≥ inventario_render.json de matriz")
        return

    with open(JSON_MATRIZ, "r", encoding="utf-8") as f:
        inventario_real = json.load(f)

    inventario_final = []
    for item in inventario_real:
        inventario_final.append({
            "codigo": item.get("codigo", "").upper(),
            "descripcion": item.get("descripcion", ""),
            "stock": int(item.get("stock", 0)),
            "agencia": "matriz"
        })

    guardar_inventario(inventario_final)
    print("‚úî Inventario de matriz actualizado")


@app.route("/actualizar-matriz", methods=["POST"])
def actualizar_desde_matriz():
    actualizar_inventario_matriz()
    return jsonify({"status": "matriz_actualizada"})


# ============================================
# EJECUCI√ìN PRODUCCI√ìN
# ============================================
if __name__ == "__main__":
    print("üî• Proxy JQ Motors Producci√≥n listo.")
    app.run(host="0.0.0.0", port=5002)
