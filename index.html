<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario General | JQ Motors</title>

<style>
    body{
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        margin:0;
        padding:0;
    }
    header{
        background:#111;
        color:white;
        padding:15px;
        text-align:center;
        font-size:22px;
        font-weight:bold;
    }
    .top-bar{
        background:white;
        padding:10px;
        box-shadow:0 0 5px rgba(0,0,0,0.2);
        position:sticky;
        top:0;
        z-index:100;
        display:flex;
        flex-direction:column;
        gap:10px;
    }
    input, select, button{
        width:100%;
        padding:12px;
        font-size:16px;
        border:1px solid #ccc;
        border-radius:8px;
    }
    button{
        background:#111;
        color:white;
        font-weight:bold;
        cursor:pointer;
    }
    .tabla{
        width:100%;
        border-collapse:collapse;
        margin-top:10px;
    }
    th, td{
        padding:10px;
        border-bottom:1px solid #ddd;
        text-align:left;
    }
    th{
        background:#444;
        color:white;
        position:sticky;
        top:180px;
        z-index:50;
    }
    .agencia-titulo{
        background:#222;
        color:white;
        padding:10px;
        font-weight:bold;
        margin-top:20px;
        font-size:18px;
    }
    #iaResultado{
        background:#fff;
        padding:10px;
        border-radius:10px;
        box-shadow:0 0 5px rgba(0,0,0,0.2);
        margin-top:15px;
        display:none;
        white-space:pre-wrap;
    }
</style>

</head>
<body>

<header>Inventario General JQ Motors</header>

<div class="top-bar">
    <input type="text" id="buscar" placeholder="Buscar c√≥digo o descripci√≥n...">
    <button onclick="buscarIA()">üîç Buscar con Inteligencia Artificial</button>
    <select id="filtroAgencia">
        <option value="todas">üîÑ Todas las agencias</option>
    </select>
</div>

<div id="iaResultado"></div>
<div id="contenido"></div>

<script>
// URL del PROXY
const PROXY_URL = "https://proxi-multitienda.onrender.com";

let inventariosGlobal = [];

async function cargarInventarios(){
    const resp = await fetch(PROXY_URL + "/inventarios/todas");
    const data = await resp.json();
    inventariosGlobal = data;

    cargarAgenciasSelector(data);
    mostrarInventarios();
}

function cargarAgenciasSelector(data){
    const select = document.getElementById("filtroAgencia");
    const agencias = [...new Set(data.map(x => x.agencia))].sort();

    agencias.forEach(a => {
        let op = document.createElement("option");
        op.value = a;
        op.textContent = "üèçÔ∏è " + a.toUpperCase();
        select.appendChild(op);
    });
}

function mostrarInventarios(){
    const cont = document.getElementById("contenido");
    cont.innerHTML = "";

    const filtroAgencia = document.getElementById("filtroAgencia").value;

    let datosFiltrados = inventariosGlobal;
    if(filtroAgencia !== "todas"){
        datosFiltrados = inventariosGlobal.filter(x => x.agencia === filtroAgencia);
    }

    const grupos = {};
    datosFiltrados.forEach(item => {
        const ag = item.agencia || "sin agencia";
        if(!grupos[ag]) grupos[ag] = [];
        grupos[ag].push(item);
    });

    Object.keys(grupos).sort().forEach(ag => {
        const inv = grupos[ag];

        let html = `
            <div class="agencia-titulo">${ag.toUpperCase()}</div>
            <table class="tabla">
                <tr>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                    <th>Stock</th>
                </tr>
        `;

        inv.forEach(pieza => {
            html += `
                <tr class="fila">
                    <td class="codigo">${pieza.codigo}</td>
                    <td class="descripcion">${pieza.descripcion}</td>
                    <td>${pieza.stock}</td>
                </tr>
            `;
        });

        html += "</table>";

        cont.innerHTML += html;
    });

    aplicarFiltroTexto();
}

document.getElementById("buscar").addEventListener("keyup", aplicarFiltroTexto);
document.getElementById("filtroAgencia").addEventListener("change", mostrarInventarios);

function aplicarFiltroTexto(){
    let filtro = document.getElementById("buscar").value.toLowerCase();

    document.querySelectorAll(".fila").forEach(fila => {
        let codigo = fila.querySelector(".codigo").innerText.toLowerCase();
        let desc = fila.querySelector(".descripcion").innerText.toLowerCase();

        fila.style.display = (codigo.includes(filtro) || desc.includes(filtro)) ? "" : "none";
    });
}

async function buscarIA(){
    let texto = document.getElementById("buscar").value.trim();
    if(texto.length < 3){
        alert("Escribe m√°s detalles para buscar con IA.");
        return;
    }

    const resBox = document.getElementById("iaResultado");
    resBox.style.display = "block";
    resBox.textContent = "‚è≥ Consultando IA...";

    try{
        const resp = await fetch(PROXY_URL + "/ia/buscar", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({texto})
        });

        const data = await resp.json();

        if(data.ia){
            resBox.textContent = data.ia;
        } else {
            resBox.textContent = "‚ùå Error: " + JSON.stringify(data);
        }

    } catch(e){
        resBox.textContent = "‚ùå Error: " + e;
    }
}

cargarInventarios();
</script>

</body>
</html>
