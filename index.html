<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventarios JQ Motors - Unificado</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
    --azul:#0044cc;
    --azul-osc:#003399;
    --bg:#f4f6fa;
    --card:#ffffff;
    --gris:#666;
    --gris-claro:#eee;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin:0; padding:0; background:var(--bg); color:#111;
}
h2 {
    margin:20px 0; color:var(--azul);
    text-align:center; font-weight:700;
}
.container {
    max-width:1200px; margin:0 auto; padding:20px;
}
.controls {
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center; margin-bottom:10px;
}
.controls .wide { flex:1 1 300px; max-width:600px; }
.controls input, .controls select, .controls button {
    padding:10px; font-size:16px; border-radius:6px;
    border:1px solid var(--gris-claro); box-sizing:border-box;
}
.controls input:focus, .controls select:focus { outline:none; border-color:var(--azul); }
.controls button {
    cursor:pointer; background:var(--azul); color:white;
    border:none; font-weight:600; transition:0.3s;
}
.controls button:hover { background:var(--azul-osc); }
#panelAgencias button {
    padding:6px 10px; border-radius:4px;
    border:none; background:var(--azul); color:white; cursor:pointer;
    margin:2px; font-size:13px;
    transition:0.3s;
}
#panelAgencias button:hover { background:var(--azul-osc); }
#mensaje {
    text-align:center; font-weight:600; color:#b00; margin-bottom:16px;
}
.scroll-box {
    width: 100%; max-height: 550px; overflow-y:auto;
    border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.12);
    background:var(--card);
}
table {
    width:100%; border-collapse:collapse;
}
thead th {
    position:sticky; top:0; background:var(--azul); color:white;
    padding:12px; font-size:13px; text-transform:uppercase; text-align:center;
}
tbody td {
    padding:10px; font-size:14px; border-bottom:1px solid var(--gris-claro);
    text-align:center;
}
tbody tr:nth-child(even){ background:#fbfbfb; }
tbody tr:hover { background:#e8f0ff; }
@media(max-width:768px){ .controls { flex-direction:column; } }
</style>
</head>
<body>
<div class="container">
    <h2>Inventarios JQ Motors - Unificado</h2>
    <div id="mensaje">Cargando inventarios...</div>

    <div class="controls">
        <input id="busqueda" class="wide" type="text" placeholder="Buscar código o descripción..." onkeyup="filtrarTodo()">
        <select id="selectAgencia" style="max-width:250px;"></select>
        <button onclick="filtrarAgencia()">Filtrar por Agencia</button>
        <button onclick="exportarInventario()" style="max-width:180px;">Exportar CSV</button>
    </div>

    <div id="panelAgencias"></div>

    <div class="scroll-box">
        <table>
            <thead>
                <tr>
                    <th>Agencia</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Stock</th>
                </tr>
            </thead>
            <tbody id="resultados"></tbody>
        </table>
    </div>
</div>

<script>
const URLS = [
    "https://inv-matriz-server.onrender.com/inventario-json",
    "https://inv-impulsora-server.onrender.com/inventario-json",
    "https://inv-tultitlan-server.onrender.com/inventario-json",
    "https://inv-ojo-de-agua-server.onrender.com/inventario-json",
    "https://inv-pachuca-server.onrender.com/inventario-json",
    "https://inv-mixquiahuala-server.onrender.com/inventario-json"
];

let inventario = [];

/* ================= CARGAR INVENTARIOS SIN REPETIR ================= */
async function cargarInventarios(){
    mostrarMensaje("Cargando inventarios...");

    const fetches = URLS.map(async url => {
        try{
            const r = await fetch(url);
            if(r.ok){
                const datos = await r.json();
                const nombreAgencia = url.replace("https://", "").split(".")[0];
                const procesados = datos.map(x => ({
                    ...x,
                    agencia: x.agencia && x.agencia.trim() !== "" ? x.agencia : nombreAgencia
                }));
                console.log(`Agencia ${nombreAgencia}: ${procesados.length} productos cargados`);
                return procesados;
            } else {
                console.warn("Error en:", url);
                return [];
            }
        }catch(e){
            console.warn("No respondió:", url);
            return [];
        }
    });

    const resultados = await Promise.all(fetches);
    resultados.forEach(datos => {
        datos.forEach(item => {
            // Evitar duplicados de la misma agencia y código
            if(!inventario.some(x => x.agencia === item.agencia && x.codigo === item.codigo)){
                inventario.push(item);
            }
        });
    });

    poblarSelectorAgencias();
    crearBotonesAgencias();
    filtrarTodo();
    mostrarMensaje("Inventarios cargados correctamente.");
}

/* ================= SELECT AGENCIAS ================= */
function poblarSelectorAgencias(){
    const sel = document.getElementById("selectAgencia");
    sel.innerHTML = '<option value="">-- Todas las agencias --</option>';
    const agencias = [...new Set(inventario.map(x=>x.agencia))].sort();
    agencias.forEach(a=>{
        const op = document.createElement("option");
        op.value = a;
        op.textContent = a.toUpperCase();
        sel.appendChild(op);
    });
}

/* ================= MOSTRAR TABLA ================= */
function mostrarResultados(datos){
    const tb = document.getElementById("resultados");
    tb.innerHTML = "";
    if(datos.length === 0){
        tb.innerHTML = "<tr><td colspan='4'>No hay datos</td></tr>";
        return;
    }
    datos.sort((a,b)=> a.agencia.localeCompare(b.agencia));
    datos.forEach(item=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${item.agencia}</td>
            <td>${item.codigo}</td>
            <td style="text-align:left">${item.descripcion}</td>
            <td>${item.stock}</td>
        `;
        tb.appendChild(tr);
    });
}

/* ================= FILTRADO ================= */
function filtrarTodo(){
    const txt = document.getElementById("busqueda").value.toLowerCase();
    const agencia = document.getElementById("selectAgencia").value;
    const filtrado = inventario.filter(x =>
        (!agencia || x.agencia === agencia) &&
        ((x.codigo||"").toLowerCase().includes(txt) || (x.descripcion||"").toLowerCase().includes(txt))
    );
    mostrarResultados(filtrado);
}
function filtrarAgencia(){ filtrarTodo(); }

/* ================= BOTONES AGENCIAS ================= */
function crearBotonesAgencias(){
    const panel = document.getElementById("panelAgencias");
    panel.innerHTML = "";
    const agencias = [...new Set(inventario.map(x=>x.agencia))].sort();

    const btnAll = document.createElement("button");
    btnAll.textContent = "Todas las agencias";
    btnAll.onclick = () => filtrarTodo();
    panel.appendChild(btnAll);

    agencias.forEach(a=>{
        const btn = document.createElement("button");
        btn.textContent = a.toUpperCase();
        btn.onclick = () => {
            const txt = document.getElementById("busqueda").value.toLowerCase();
            const filtrado = inventario.filter(x =>
                x.agencia === a &&
                ((x.codigo||"").toLowerCase().includes(txt) || (x.descripcion||"").toLowerCase().includes(txt))
            );
            mostrarResultados(filtrado);
        };
        panel.appendChild(btn);
    });
}

/* ================= EXPORTAR ================= */
function exportarInventario(){
    const txt = document.getElementById("busqueda").value.toLowerCase();
    const agencia = document.getElementById("selectAgencia").value;
    const filtrado = inventario.filter(x =>
        (!agencia || x.agencia === agencia) &&
        ((x.codigo||"").toLowerCase().includes(txt) || (x.descripcion||"").toLowerCase().includes(txt))
    );
    let csv = "Agencia,Código,Descripción,Stock\n";
    filtrado.forEach(x=>{
        csv += `"${x.agencia}","${x.codigo}","${x.descripcion}","${x.stock}"\n`;
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "inventario_filtrado.csv";
    a.click();
}

/* ================= UTIL ================= */
function mostrarMensaje(t){ document.getElementById("mensaje").textContent = t; }

/* ================= INICIO ================= */
cargarInventarios();
</script>
</body>
</html>
